<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRILink Pro v4.9.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .active-nav { background: #2563eb !important; color: white !important; }
        .page { display: none; height: 100%; overflow-y: auto; padding-bottom: 120px; }
        .page.active { display: block; }
        .fmt-number { font-feature-settings: "tnum"; }
        /* Style khusus Navbar HP */
        .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #0f172a; display: flex; justify-content: space-around; padding: 12px; z-index: 100; border-top: 1px solid #1e293b; }
        .mobile-nav button { color: #94a3b8; font-size: 20px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .mobile-nav button span { font-size: 8px; font-weight: 800; text-transform: uppercase; }
        .mobile-nav button.active-mobile { color: #fbbf24; }
    </style>
</head>
<body class="bg-slate-100 flex-col md:flex-row">

    <aside class="hidden md:flex flex-col w-72 bg-slate-950 text-white p-6 h-full shadow-2xl">
        <div class="mb-6 p-5 bg-blue-900 rounded-2xl border-2 border-blue-700 shadow-xl">
            <h1 id="sidebar-title" class="text-xl font-800 text-white tracking-tighter uppercase mb-2">AGEN BRILINK</h1>
            <div class="flex items-center gap-2 border-t border-blue-800 pt-2 uppercase font-bold text-[10px]">
                <i class="fas fa-user-circle text-yellow-400"></i> <span id="user-side">OWNER</span>
            </div>
        </div>
        
        <nav class="space-y-2 flex-1">
            <button onclick="nav('page-home')" class="nav-btn w-full flex items-center gap-4 p-4 text-[11px] font-bold rounded-xl transition-all" data-id="page-home"><i class="fas fa-cash-register"></i> KASIR</button>
            <button onclick="nav('page-audit')" class="nav-btn w-full flex items-center gap-4 p-4 text-[11px] font-bold rounded-xl transition-all" data-id="page-audit"><i class="fas fa-university"></i> KELOLA SALDO</button>
            <button onclick="nav('page-inject')" class="nav-btn w-full flex items-center gap-4 p-4 text-[11px] font-bold rounded-xl transition-all" data-id="page-inject"><i class="fas fa-plus-circle"></i> SUNTIK MODAL</button>
            <button onclick="nav('page-history')" class="nav-btn w-full flex items-center gap-4 p-4 text-[11px] font-bold rounded-xl transition-all" data-id="page-history"><i class="fas fa-history"></i> RIWAYAT</button>
            <button onclick="nav('page-debt')" class="nav-btn w-full flex items-center gap-4 p-4 text-[11px] font-bold rounded-xl transition-all" data-id="page-debt"><i class="fas fa-user-clock"></i> HUTANG</button>
        </nav>

        <div class="pt-6 border-t border-slate-800 space-y-3">
            <button onclick="endSession()" class="w-full bg-orange-600 p-3 rounded-xl text-[10px] font-900 uppercase">Akhiri Sesi</button>
            <button id="btn-logout" class="w-full bg-slate-800 p-3 rounded-xl text-[10px] font-900 uppercase">Logout</button>
        </div>
    </aside>

    <div class="mobile-nav md:hidden">
        <button onclick="nav('page-home')" id="m-home"><i class="fas fa-cash-register"></i><span>Kasir</span></button>
        <button onclick="nav('page-audit')" id="m-audit"><i class="fas fa-university"></i><span>Saldo</span></button>
        <button onclick="nav('page-inject')" id="m-inject"><i class="fas fa-plus-circle"></i><span>Suntik</span></button>
        <button onclick="nav('page-history')" id="m-history"><i class="fas fa-history"></i><span>Data</span></button>
        <button onclick="nav('page-debt')" id="m-debt"><i class="fas fa-user-clock"></i><span>Hutang</span></button>
    </div>

    <div class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="bg-white border-b p-4 shadow-sm z-10">
            <div class="max-w-7xl mx-auto flex justify-between items-center mb-4">
                <button id="btn-sync-manual" class="flex items-center gap-2 px-3 py-1 bg-slate-50 border rounded-full">
                    <div id="sync-dot" class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span id="sync-text" class="text-[9px] font-900 uppercase">Synced</span>
                </button>
                <div class="flex gap-2">
                    <button onclick="exportToExcel()" class="bg-green-600 text-white p-2 rounded-lg text-[10px] font-bold px-4">EXCEL</button>
                    <button id="btn-logout-mob" class="md:hidden bg-red-600 text-white p-2 rounded-lg text-[10px] font-bold uppercase px-4">OUT</button>
                </div>
            </div>

            <div class="flex gap-2 overflow-x-auto pb-2 fmt-number">
                <div class="bg-blue-600 p-3 rounded-xl text-white min-w-[120px]"><p class="text-[7px] font-bold uppercase opacity-70">Laci</p><h3 id="stat-laci" class="text-[11px] font-900">Rp 0</h3></div>
                <div class="bg-white p-3 rounded-xl border min-w-[110px]"><p class="text-[7px] font-bold uppercase text-slate-400">BRI</p><h3 id="stat-bri" class="text-[11px] font-900 text-blue-700">Rp 0</h3></div>
                <div class="bg-white p-3 rounded-xl border min-w-[110px]"><p class="text-[7px] font-bold uppercase text-slate-400">DANA</p><h3 id="stat-dana" class="text-[11px] font-900 text-sky-600">Rp 0</h3></div>
                <div class="bg-red-50 p-3 rounded-xl border min-w-[110px]"><p class="text-[7px] font-bold uppercase text-red-500">Hutang</p><h3 id="stat-hutang" class="text-[11px] font-900 text-red-600">Rp 0</h3></div>
            </div>
        </header>

        <main class="p-4 flex-1 overflow-hidden relative">
            
            <div id="page-home" class="page active max-w-xl mx-auto">
                <div id="lock-warning" class="bg-red-600 text-white p-4 rounded-xl mb-4 text-center font-bold text-[10px] uppercase shadow-lg">⚠️ SESI BELUM DIMULAI! ISI SALDO DI MENU SALDO.</div>
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border">
                    <div class="flex gap-1 mb-6 bg-slate-100 p-1 rounded-xl">
                        <button onclick="setType('TRANSFER')" id="t-TRANSFER" class="flex-1 py-3 text-[10px] font-900 rounded-lg bg-blue-600 text-white">TRANSFER</button>
                        <button onclick="setType('TARIK')" id="t-TARIK" class="flex-1 py-3 text-[10px] font-900 rounded-lg text-slate-500">TARIK</button>
                        <button onclick="setType('PULSA')" id="t-PULSA" class="flex-1 py-3 text-[10px] font-900 rounded-lg text-slate-500">PULSA</button>
                    </div>

                    <div class="space-y-4">
                        <div id="box-standard"><input type="number" id="inp-nom" placeholder="Rp Nominal" class="w-full p-4 bg-slate-50 rounded-xl text-2xl font-900 outline-none ring-2 ring-transparent focus:ring-blue-100"></div>
                        <div id="box-admin" class="grid grid-cols-2 gap-2">
                            <input type="number" id="inp-adm" value="5000" class="p-3 bg-slate-50 border rounded-lg font-bold">
                            <input type="number" id="inp-bia" value="3000" class="p-3 bg-slate-50 border rounded-lg font-bold">
                        </div>
                        <div id="box-pulsa" class="hidden grid grid-cols-2 gap-2">
                            <input type="number" id="inp-mod" placeholder="Modal" class="p-3 bg-orange-50 border rounded-lg font-bold">
                            <input type="number" id="inp-jual" placeholder="Jual" class="p-3 bg-green-50 border rounded-lg font-bold">
                        </div>
                        <div class="p-4 bg-slate-100 rounded-xl">
                            <label class="text-[8px] font-bold block mb-2 uppercase text-blue-600">Dibayar Pelanggan Sekarang</label>
                            <input type="number" id="inp-pay-now" placeholder="Lunas / DP?" class="w-full p-3 bg-white border-2 border-blue-200 rounded-lg font-900 text-xl text-blue-700 outline-none">
                        </div>
                        <button id="btn-save" class="w-full bg-blue-700 text-white font-900 py-5 rounded-2xl text-[11px] uppercase shadow-xl">Simpan Transaksi</button>
                    </div>
                </div>
            </div>

            <div id="page-audit" class="page max-w-xl mx-auto">
                <div class="bg-white p-8 rounded-[2rem] border">
                    <h2 class="text-center font-900 text-[10px] mb-6 uppercase">Setup Saldo Awal Sesi</h2>
                    <div class="space-y-4" id="audit-fields">
                        <input type="number" id="audit-laci" placeholder="Laci" class="audit-input w-full p-4 bg-slate-50 border rounded-xl font-900 text-xl">
                        <input type="number" id="audit-bri" placeholder="BRI" class="audit-input w-full p-4 bg-slate-50 border rounded-xl font-900 text-xl">
                        <input type="number" id="audit-dana" placeholder="DANA" class="audit-input w-full p-4 bg-slate-50 border rounded-xl font-900 text-xl">
                    </div>
                    <button id="btn-lock-audit" onclick="lockAudit()" class="w-full bg-slate-900 text-white font-900 py-4 rounded-xl text-[10px] uppercase mt-6 shadow-xl">Mulai Sesi Sekarang</button>
                    <div id="audit-locked-msg" class="hidden text-center text-green-600 font-900 text-xs mt-4">SESI BERJALAN ✅</div>
                </div>
            </div>

            <div id="page-inject" class="page max-w-xl mx-auto">
                <div class="bg-white p-8 rounded-[2rem] border">
                    <h2 class="text-center font-900 text-[10px] mb-6 uppercase">Suntik Modal Tambahan</h2>
                    <input type="number" id="inj-nom" placeholder="Rp Nominal" class="w-full p-4 bg-slate-50 border rounded-xl font-900 text-xl mb-4">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="injectModal('laci')" class="p-4 bg-emerald-600 text-white rounded-xl font-900 text-[9px] uppercase">Laci</button>
                        <button onclick="injectModal('bri')" class="p-4 bg-blue-600 text-white rounded-xl font-900 text-[9px] uppercase">BRI</button>
                    </div>
                </div>
            </div>

            <div id="page-history" class="page max-w-3xl mx-auto space-y-2"></div>
            <div id="page-debt" class="page max-w-3xl mx-auto space-y-2"></div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFUlHciJ3ms6bViuLbog2J66-k-oF4DLM",
            authDomain: "brilink-jaman-now.firebaseapp.com",
            databaseURL: "https://brilink-jaman-now-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "brilink-jaman-now",
            storageBucket: "brilink-jaman-now.firebasestorage.app",
            messagingSenderId: "856199740278",
            appId: "1:856199740278:web:95066429f78e87d9d49857"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);

        let activeType = 'TRANSFER', isSynced = true;
        let state = JSON.parse(localStorage.getItem('brilink_v4_local')) || {
            title: "AGEN BRILINK", currentUser: {name:"OWNER"}, 
            saldo: {laci:0, bri:0, dana:0, hutang:0, pulsa:0}, logs:[], isLocked: false
        };

        const fmt = (v) => "Rp " + Math.round(v).toLocaleString('id-ID');

        window.nav = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Update UI Nav Mobile
            document.querySelectorAll('.mobile-nav button').forEach(b => b.classList.remove('active-mobile'));
            const mobBtn = { 'page-home': 'm-home', 'page-audit': 'm-audit', 'page-inject': 'm-inject', 'page-history': 'm-history', 'page-debt': 'm-debt' };
            if(mobBtn[id]) document.getElementById(mobBtn[id]).classList.add('active-mobile');
            
            renderUI();
        };

        window.lockAudit = () => {
            state.saldo.laci = parseFloat(document.getElementById('audit-laci').value) || 0;
            state.saldo.bri = parseFloat(document.getElementById('audit-bri').value) || 0;
            state.saldo.dana = parseFloat(document.getElementById('audit-dana').value) || 0;
            state.isLocked = true;
            saveLocal();
        };

        window.endSession = () => {
            if(!isSynced) return alert("Upload data dulu (Sync)!");
            if(confirm("Akhiri sesi?")) {
                state.isLocked = false; state.logs = [];
                localStorage.removeItem('brilink_v4_local');
                location.reload();
            }
        };

        window.setType = (type) => {
            activeType = type;
            document.getElementById('box-standard').style.display = type === 'PULSA' ? 'none' : 'block';
            document.getElementById('box-admin').style.display = type === 'PULSA' ? 'none' : 'flex';
            document.getElementById('box-pulsa').style.display = type === 'PULSA' ? 'grid' : 'none';
            document.querySelectorAll('#t-TRANSFER, #t-TARIK, #t-PULSA').forEach(b => {
                b.className = b.id === 't-'+type ? 'flex-1 py-3 text-[10px] font-900 rounded-lg bg-blue-600 text-white' : 'flex-1 py-3 text-[10px] font-900 rounded-lg text-slate-500';
            });
        };

        document.getElementById('btn-save').addEventListener('click', () => {
            if(!state.isLocked) return alert("Sesi Belum Dimulai!");
            const nom = parseFloat(document.getElementById('inp-nom').value) || 0;
            const adm = parseFloat(document.getElementById('inp-adm').value) || 0;
            const payNow = parseFloat(document.getElementById('inp-pay-now').value) || 0;
            let totalWajib = 0, laba = 0;

            if(activeType === 'PULSA') {
                const mod = parseFloat(document.getElementById('inp-mod').value) || 0;
                const jual = parseFloat(document.getElementById('inp-jual').value) || 0;
                totalWajib = jual; laba = jual - mod;
                state.saldo.pulsa -= mod;
            } else if(activeType === 'TRANSFER') {
                totalWajib = nom + adm; laba = adm - 3000;
                state.saldo.bri -= (nom + 3000);
            } else { // TARIK
                totalWajib = adm; laba = adm;
                state.saldo.bri += nom; state.saldo.laci -= nom;
            }

            const sisa = totalWajib - payNow;
            if(payNow > 0) state.saldo.laci += payNow;
            if(sisa > 0) state.saldo.hutang += sisa;

            state.logs.push({ id: Date.now(), type: activeType, nom: totalWajib, laba, sisa, isH: sisa > 0 });
            updateSyncUI('PENDING'); saveLocal();
            alert("Berhasil!");
        });

        const updateSyncUI = (s) => {
            isSynced = s === 'DONE';
            document.getElementById('sync-dot').className = isSynced ? "w-3 h-3 rounded-full bg-green-500" : "w-3 h-3 rounded-full bg-red-500 animate-pulse";
            document.getElementById('sync-text').innerText = isSynced ? "Synced" : "Need Sync";
        };

        document.getElementById('btn-sync-manual').addEventListener('click', async () => {
            if(auth.currentUser) { await update(ref(rtdb, 'v4/'+auth.currentUser.uid), state); updateSyncUI('DONE'); }
        });

        const logoutAction = () => { if(confirm("Keluar dari akun?")) signOut(auth).then(()=>location.reload()); };
        document.getElementById('btn-logout').onclick = logoutAction;
        document.getElementById('btn-logout-mob').onclick = logoutAction;

        function saveLocal() { localStorage.setItem('brilink_v4_local', JSON.stringify(state)); renderUI(); }

        function renderUI() {
            document.getElementById('user-side').innerText = state.currentUser.name;
            document.getElementById('stat-laci').innerText = fmt(state.saldo.laci);
            document.getElementById('stat-bri').innerText = fmt(state.saldo.bri);
            document.getElementById('stat-dana').innerText = fmt(state.saldo.dana);
            document.getElementById('stat-hutang').innerText = fmt(state.saldo.hutang);

            document.querySelectorAll('.audit-input').forEach(i => i.disabled = state.isLocked);
            document.getElementById('btn-lock-audit').style.display = state.isLocked ? 'none' : 'block';
            document.getElementById('audit-locked-msg').style.display = state.isLocked ? 'block' : 'none';
            document.getElementById('lock-warning').style.display = state.isLocked ? 'none' : 'block';

            document.getElementById('page-history').innerHTML = state.logs.slice().reverse().map(l => `
                <div class="bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm">
                    <div><p class="text-[8px] font-bold text-slate-400 uppercase">${l.type}</p><h4 class="text-xs font-900">${fmt(l.nom)}</h4></div>
                    <div class="text-right"><p class="text-[7px] text-green-500 font-bold uppercase">Laba</p><h4 class="text-xs font-900">${fmt(l.laba)}</h4></div>
                </div>
            `).join('');
        }

        onAuthStateChanged(auth, (u) => { if(u) renderUI(); else alert("Silahkan Login!"); });
        nav('page-home');
    </script>
</body>
</html>
